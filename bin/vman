#!/bin/sh
# <- Pager <- Vim: https://vim.fandom.com/wiki/Using_vim_as_a_man-page_viewer_under_Unix
# <- Check size <- https://unix.stackexchange.com/questions/245064/what-is-the-best-way-to-pipe-the-output-of-a-command-through-a-pager-if-and-onl
# <- Pass argument dynamically <- https://unix.stackexchange.com/questions/459367/using-shell-variables-for-command-options
# Require perl, tput (in ncurses-utils), less

unset PAGER

# Helper: Call vim with arguments
call_vim(){
    vim -R \
    --not-a-term \
    -c 'map q :q!<CR>' \
    -c 'map <SPACE> <C-D>' -c 'map b <C-U>' \
    -c 'set foldlevel=30'  \
    "$@"
}

# PAGER for manpages (prefix by col)
man_col(){
    col -b -x | call_vim \
        -c 'set ft=man nomod nolist' \
        -c 'nmap K :Man <C-R>=expand(\\\"<cword>\\\")<CR><CR>' \
        -
}

# As before but with - -> $1 (i.e. STDIN -> ARG_1)
man_cat_col(){
    less "$1" | man_col
}

# PAGER for git diff files (Ansi-Escaped)
man_ansi() {
    call_vim \
        -c 'packadd ansiesc' -c 'AnsiEsc' -
}


# Discrimintate size of stdin to pipe in (vim | less | cat)
man_select(){
    buffer=$(mktemp)
    rows="${LINES:=$(tput lines)}"
    cols="${COLUMNS:=$(tput cols)}"
    while true; do
        # Read
        IFS= read -r some_data
        eof=$?        # 1 if EOF, 0 if normal, successful read.

        # Write to buffer
        printf "%s" "$some_data" >> "$buffer"
        if [ "$eof" = 0 ]; then
            printf "\n" >> "$buffer"
        fi

        # If Small
        n_virt=$(fold -w"$cols" "$buffer" | wc -l)
        if [ "$n_virt" -lt "$rows" ]; then
            if [ "$eof" != 0 ]; then
                less "$buffer"
            else
                # If not finished continue reading
                continue
            fi

        # Elif Large
        else
            # But with EOF so cat
            if [ "$eof" != 0 ]; then
                "${PAGER:="less"}" < "$buffer"
            # So work
            else
                # Choose PAGER according to AnsiEsc detection
                man_cmd="man_col"
                perl -ne 'exit 42 if m/\e\[[0-9;]*[mG]/' "$buffer"
                [ $? = 42 ] && man_cmd="man_ansi"
                # Concatenate buffer (size of the screen) and stdin (-)
                less "$buffer" - |
                # Go in Vim
                "${PAGER:="$man_cmd"}"
            fi
        fi
        break
    done
    rm "$buffer"
}


man_main() {
    # See if argument commes from stdin (unix) or file first argument (man on termux)
    if [ ! -z "$1" ] ; then
        man_cat_col "$1"
    else
        man_select
    fi
}

man_main "$1"
